<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>wsl-arch-vscode manual</title>
    <link href="/2025/03/24/wslmanual/"/>
    <url>/2025/03/24/wslmanual/</url>
    
    <content type="html"><![CDATA[<h1 id="wsl-arch-vscode-manual"><a href="#wsl-arch-vscode-manual" class="headerlink" title="wsl-arch-vscode manual"></a>wsl-arch-vscode manual</h1><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241352823.png" alt="wslé¬¼å›¾"></p><h1 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h1><h3 id="windowsè®¾ç½®ï¼šå¼€å¯wsl"><a href="#windowsè®¾ç½®ï¼šå¼€å¯wsl" class="headerlink" title="windowsè®¾ç½®ï¼šå¼€å¯wsl"></a>windowsè®¾ç½®ï¼šå¼€å¯wsl</h3><ul><li><p>wslé€‰é¡¹åŠŸèƒ½æ‰“å¼€</p><p>  <a href="https://blog.cls.ink/2024/10/18/WSL2-SpeedRun/">WSL2 SpeedRun Any% - MrBeanC-Blog</a> ğŸ˜Š</p></li></ul><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241352166.png" alt="è®¾ç½®å¼€å¯wslåŠŸèƒ½"></p><ul><li>powershellï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wsl install â€” no distribution<br></code></pre></td></tr></table></figure><ul><li>å®‰è£…nerd font<ul><li>windowså®‰è£…å­—ä½“çš„æ–¹æ³•ï¼š<a href="https://support.microsoft.com/en-us/office/add-a-font-b7c5f17c-4426-4b53-967f-455339c564c1">Add a font - Microsoft Support</a></li></ul></li></ul><h1 id="archå®‰è£…"><a href="#archå®‰è£…" class="headerlink" title="archå®‰è£…"></a>archå®‰è£…</h1><h2 id="è§£å‹å®‰è£…å’Œè®¾ç½®rootç”¨æˆ·"><a href="#è§£å‹å®‰è£…å’Œè®¾ç½®rootç”¨æˆ·" class="headerlink" title="è§£å‹å®‰è£…å’Œè®¾ç½®rootç”¨æˆ·"></a>è§£å‹å®‰è£…å’Œè®¾ç½®rootç”¨æˆ·</h2><p><a href="https://github.com/yuk7/ArchWSL">https://github.com/yuk7/ArchWSL</a></p><ul><li><p>ä¸‹è½½releaseç‰ˆæœ¬ä¸­ arch.zipï¼Œè§£å‹åˆ°æŸä¸ªç›®å½•ä¸‹ï¼Œä½œä¸ºå­˜æ”¾ç¡¬ç›˜æ˜ åƒçš„ä½ç½®</p><ul><li><code>Arch.exe</code>çš„æ–‡ä»¶åå¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼Œä½œä¸ºå‘½åè¯¥wslå®ä¾‹çš„åå­—ï¼Œåœ¨ç»ˆç«¯ä¼šæ˜¾ç¤ºä¸€è‡´çš„å‘½å</li></ul></li><li><p>åŒå‡»<code>$&#123;Archname&#125;.exe</code>ï¼Œå®‰è£…roofts</p><ul><li>è¯¥ç›®å½•ä¸­ä¼šå¤šå‡ºä¸€ä¸ªç¡¬ç›˜æ˜ åƒæ–‡ä»¶ï¼Œä¼šéšç€ä½¿ç”¨è€Œä½“ç§¯å˜å¤§</li></ul></li><li><p>å†æ¬¡åŒå‡»<code>$&#123;Archname&#125;.exe</code>ï¼Œè®¾ç½®rootå’Œroot password</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">passwd<br></code></pre></td></tr></table></figure></li></ul><h2 id="è®¾ç½®æ—¥å¸¸ç”¨æˆ·"><a href="#è®¾ç½®æ—¥å¸¸ç”¨æˆ·" class="headerlink" title="è®¾ç½®æ—¥å¸¸ç”¨æˆ·"></a>è®¾ç½®æ—¥å¸¸ç”¨æˆ·</h2><ul><li><p><strong>Archç»ˆç«¯ä¸­</strong>æ‰“å¼€å¹¶è®¾ç½®sudoers file</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;%wheel ALL=(ALL) ALL&quot;</span> &gt; /etc/sudoers.d/wheel<br></code></pre></td></tr></table></figure><ul><li>æ·»åŠ æ—¥å¸¸ç”¨æˆ·å å’Œ å¯¹åº”ç”¨æˆ·çš„å¯†ç </li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">useradd -m -G wheel -s /bin/bash &#123;username&#125;<br></code></pre></td></tr></table></figure>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">passwd &#123;username&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>powershellç»ˆç«¯</strong>ä¸­ï¼Œåœ¨<code>$&#123;Archname&#125;.exe</code>æ‰€åœ¨ç›®å½•æ‰“å¼€</p><ul><li>è®¾ç½®é»˜è®¤ä¸ºæ—¥å¸¸ç”¨æˆ·</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">.\Arch1.exe config --default-user &#123;username&#125;<br></code></pre></td></tr></table></figure></li></ul><blockquote><p>ä¼šé‡åˆ°æŠ¥é”™è¯´ï¼šwsl: æ£€æµ‹åˆ° localhost ä»£ç†é…ç½®ï¼Œä½†æœªé•œåƒåˆ° WSLã€‚NAT æ¨¡å¼ä¸‹çš„ WSL ä¸æ”¯æŒ localhost ä»£ç†ã€‚</p><ul><li>è¿™æ˜¯å› ä¸ºç½‘ç»œæ¨¡å¼é»˜è®¤æ˜¯NAT</li><li>è¿™ç§æƒ…å†µä¸‹åœ¨powershellæ‰“å¼€archç›®å½•è®¾ç½®<code>.\Arch1.exe config --default-user matoka</code> ä¼šæŠ¥é”™è¯´<code>ERR: wsl: ï¿½hKm0R localhost ï¿½NtMï¿½n</code></li></ul></blockquote><ul><li><p>éœ€è¦åœ¨<code>C:\Users\&#123;username&#125;</code> ä¸‹è®¾ç½®<code>.wslconfig</code>æ¥æ›´æ”¹ç½‘ç»œé…ç½®</p><ul><li><p>é¦–å…ˆå…³é—­æ‰€æœ‰wslè¿è¡Œçš„å®ä¾‹ï¼Œå¯ä»¥é€‰æ‹©åœ¨Archç»ˆç«¯ä¸‹<code>exit</code></p></li><li><p>ä¹Ÿå¯ä»¥åœ¨powershellä¸­</p><ul><li><p>å…³é—­æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å‘è¡Œç‰ˆ</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wsl --shutdown<br></code></pre></td></tr></table></figure></li><li><p>å…³é—­ç‰¹å®šçš„å‘è¡Œç‰ˆ</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wsl --terminate &lt;distroName&gt;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>powershellæŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å‘è¡Œç‰ˆ</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wsl --list --running<br></code></pre></td></tr></table></figure></li><li><p><code>C:\Users\&#123;username&#125;\.wslconfig</code> ä¸­é…ç½®ç½‘ç»œéƒ¨åˆ†è®¾ç½®</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Enable experimental features</span><br>[experimental]<br>autoMemoryReclaim=gradual  <br>networkingMode=mirrored<br>dnsTunneling=<span class="hljs-literal">true</span><br>firewall=<span class="hljs-literal">true</span><br>autoProxy=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li><li><p><a href="https://learn.microsoft.com/en-us/windows/wsl/wsl-config#configure-global-options-with-wslconfig">Advanced settings configuration in WSL | Microsoft Learn</a></p></li></ul></li><li><p>Tipsï¼šå‘ç°ä»ç»ˆç«¯ä¸‹æ‹‰é€‰æ‹©ä¼é¹…å¤´ Archæ‰“å¼€ å’Œ ä»<code>$&#123;Archname&#125;.exe</code>æ‰€åœ¨ç›®å½•åŒå‡»<code>$&#123;Archname&#125;.exe</code> å¾—åˆ°çš„ç»ˆç«¯çš„å…‰æ ‡å‰æç¤ºç¬¦ä¸åŒ</p><p>  <img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241352441.jpg" alt="ä»ç»ˆç«¯çš„wslé€‰é¡¹å¡æ‰“å¼€"></p><p>  <img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241352994.png" alt="ä»exeæ‰€åœ¨ç›®å½•æ‰“å¼€"></p><ul><li>ä»æ–‡ä»¶èµ„æºç®¡ç†å™¨çš„.exeæ‰€åœ¨ç›®å½•æ‰“å¼€ï¼Œåˆ™æç¤ºäº†å½“å‰çš„å·¥ä½œç›®å½•æ˜¯<code>D:\32417101\wsl\arch-1\Arch</code> ï¼›åœ¨ Linux ä¸­ï¼Œ<code>~</code> æ˜¯ä¸€ä¸ªå¿«æ·ç¬¦å·ï¼ŒæŒ‡å‘å½“å‰ç”¨æˆ·çš„ä¸»ç›®å½•ï¼ˆå¦‚ <code>/home/username</code>ï¼‰</li></ul></li></ul><p>è”ç½‘</p><p>å¼€å‘ideç¯å¢ƒ neo vim &#x2F; vscode </p><p>windowsæ–‡ä»¶å…±äº«</p><p>æ±‰å­—è¾“å…¥æ³•</p><h2 id="pacmanåˆå§‹åŒ–å’Œå®‰è£…åŒ…"><a href="#pacmanåˆå§‹åŒ–å’Œå®‰è£…åŒ…" class="headerlink" title="pacmanåˆå§‹åŒ–å’Œå®‰è£…åŒ…"></a>pacmanåˆå§‹åŒ–å’Œå®‰è£…åŒ…</h2><ul><li>åœ¨æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­æ‰“å¼€<code>$&#123;Archname&#125;.exe</code>  <img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241353042.jpg" alt="pacmanå¯†é’¥ç¯">  è¾“å…¥ä¸‹åˆ—å‘½ä»¤  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[user@PC-NAME]$ sudo pacman-key --init<br><br>[user@PC-NAME]$ sudo pacman-key --populate<br><br>[user@PC-NAME]$ sudo pacman -Sy archlinux-keyring<br><br><span class="hljs-comment"># æ›´æ–°æ‰€æœ‰çš„åŒ…</span><br>[user@PC-NAME]$ sudo pacman -Su<br></code></pre></td></tr></table></figure><ul><li>ä»¥å‰çš„è§†é¢‘é‡Œé¢ï¼Œupå±•ç¤ºçš„åŒ…æœ‰ä¸‰ä¸ªæœ‰communityï¼Œç°åœ¨communityå·²ç»æ²¡äº†</li></ul><p>  <img src="/image%203.png" alt="image.png"></p><p>  <img src="/03f66b51e0043199153a8cd18ec956e.jpg" alt="pacman"></p></li></ul><h2 id="é…ç½®å¼€å‘ç¯å¢ƒï¼ˆC-CMakeï¼‰"><a href="#é…ç½®å¼€å‘ç¯å¢ƒï¼ˆC-CMakeï¼‰" class="headerlink" title="é…ç½®å¼€å‘ç¯å¢ƒï¼ˆC++ CMakeï¼‰"></a>é…ç½®å¼€å‘ç¯å¢ƒï¼ˆC++ CMakeï¼‰</h2><h2 id="ä½¿ç”¨vscode-in-windows-wsl-åˆ°-arch"><a href="#ä½¿ç”¨vscode-in-windows-wsl-åˆ°-arch" class="headerlink" title="ä½¿ç”¨vscode(in windows) wsl åˆ° arch"></a>ä½¿ç”¨vscode(in windows) wsl åˆ° arch</h2><ul><li>windowsä¸Šå®‰è£…vscodeï¼Œå¹¶ä¸”å®‰è£…wslæ‹“å±•</li><li>ç”¨wslè¿æ¥åˆ°archçš„æ—¶å€™ï¼Œä¸€å®šè¦å…ˆç¡®ä¿archçš„ç»ˆç«¯å¼€ç€<ul><li><p>ä¸ç„¶ä¼šæœ‰è¿·ã®æŠ¥é”™ï¼š</p><p>  <img src="/image%204.png" alt="error"></p></li><li><p>ä½†æ˜¯å¹¶ä¸éœ€è¦æ‰‹åŠ¨å»wslç»ˆç«¯è¾“å…¥ä»»ä½•å‘½ä»¤å®‰è£…vscode</p></li></ul></li></ul><h2 id="archä¸­å®‰è£…æ‰€éœ€è¦çš„è½¯ä»¶åŒ…ï¼ˆGCCå«G-GDB-CMake-å’Œ-ï¼‰"><a href="#archä¸­å®‰è£…æ‰€éœ€è¦çš„è½¯ä»¶åŒ…ï¼ˆGCCå«G-GDB-CMake-å’Œ-ï¼‰" class="headerlink" title="archä¸­å®‰è£…æ‰€éœ€è¦çš„è½¯ä»¶åŒ…ï¼ˆGCCå«G++ GDB CMake  å’Œ ???ï¼‰"></a>archä¸­å®‰è£…æ‰€éœ€è¦çš„è½¯ä»¶åŒ…ï¼ˆGCCå«G++ GDB CMake  å’Œ ???ï¼‰</h2><ul><li><p>é¦–å…ˆç¡®ä¿å·²æœ‰çš„æ‰€æœ‰åŒ…éƒ½èƒ½åŒæ­¥æ›´æ–°</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo pacman -Syu<br></code></pre></td></tr></table></figure></li><li><p>çœ‹çœ‹åŒ…å«äº›ä»€ä¹ˆåŒ…ï¼ˆå‡è£…proï¼‰ï¼ˆå…¶å®å•¥ä¹Ÿæ²¡çœ‹æ˜ç™½._.ï¼‰</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo pacman -Ss gcc<br></code></pre></td></tr></table></figure></li><li><p>æ­£å¼å®‰è£…</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo pacman -S gcc<br></code></pre></td></tr></table></figure></li><li><p>éªŒè¯æŸ¥çœ‹ç‰ˆæœ¬</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc --version<br></code></pre></td></tr></table></figure></li><li><p>é‡å¤ä¸Šè¿°çš„æ­¥éª¤æ¥å®‰è£…<code>gdb</code>å’Œ <code>cmake</code></p></li></ul><p>Ref: <a href="https://cn.linux-console.net/?p=15089">å¦‚ä½•ä¸º Arch Linux å®‰è£… GCC</a></p><p>Ref: å¸¸è§çš„pacmanæŒ‡ä»¤è§<a href="https://wiki.archlinux.org/title/Pacman">pacman - ArchWiki</a></p><ul><li>è¿™é‡Œæˆ‘ä¸€å¼€å§‹æ¼è£…äº†ä¸€ä¸ªä¸œè¥¿ ï¼ˆbuild toolï¼‰æ¯”å¦‚<code>make</code> å’Œ <code>ninja</code></li></ul><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241353555.png" alt="extension list"></p><h2 id="vscode-ï¼ˆwindowsç«¯ï¼‰å®‰è£…extension-åˆ°-wsl"><a href="#vscode-ï¼ˆwindowsç«¯ï¼‰å®‰è£…extension-åˆ°-wsl" class="headerlink" title="vscode ï¼ˆwindowsç«¯ï¼‰å®‰è£…extension åˆ° wsl"></a>vscode ï¼ˆwindowsç«¯ï¼‰å®‰è£…extension åˆ° wsl</h2><ul><li><p>è¿æ¥åˆ°wslåï¼Œç‚¹å‡»extensionï¼Œä¼šå‘ç°æœ‰ä¸¤ä¸ªåˆ†åŒºï¼Œæ˜¾ç¤ºä¸€éƒ¨åˆ†æ˜¯localï¼ˆwindowsç«¯ï¼‰ï¼Œä¸€éƒ¨åˆ†æ˜¯wslï¼›æ‹“å±•çš„åé¢éƒ½æœ‰ä¸€ä¸ªinstall in wslï¼ˆæ²¡æœ‰<strong>ed</strong>ç»“å°¾ï¼Œè¯æ˜æ­¤æ—¶wslé‡Œé¢ä»€ä¹ˆæ‹“å±•éƒ½æ²¡æœ‰)</p></li><li><p>vscodeä¸­çš„æ‹“å±•å·¥ä½œåŸç†ï¼šæ˜¯åŸºäºhostç³»ç»Ÿé‡Œé¢å·²ç»å®‰è£…äº†å„ç§åº•å±‚çš„å·¥å…·ï¼ˆæ¯”å¦‚ç¼–è¯‘å™¨ç»„ä»¶ï¼Œæ¯”å¦‚cmakeï¼‰å› æ­¤<strong>vscodeçš„å¯¹åº”æ‹“å±•</strong>ä»¥åŠåˆšæ‰åœ¨<strong>archå®‰è£…çš„å·¥å…·</strong>ï¼Œ<strong>ä¸¤è€…éƒ½æ˜¯éœ€è¦</strong>çš„ï¼ˆå¦‚æœåªæœ‰archä¸Šå®‰è£…çš„å·¥å…·ï¼Œæ²¡åŠæ³•ç”¨vscodeçš„.vscodeæ¥è¿›è¡Œå‘½ä»¤ï¼ˆå³é€šè¿‡jsonæ¥æ§åˆ¶åº•å±‚è¿™äº›å·¥å…·çš„æŒ‡ä»¤é«˜æ•ˆæ„å»ºå’Œè¿è¡Œç­‰ï¼‰</p><ul><li>å¯ä»¥ç†è§£ä¸ºvscodeçš„æ‹“å±•æ˜¯ç»™å¯¹åº”çš„å·¥å…·å¥—äº†ä¸€ä¸ªå£³å­æ¥å£ï¼Œæ–¹ä¾¿ç”¨æˆ·ç®¡ç†</li></ul></li><li><p>éœ€è¦å®‰è£…çš„æ‹“å±•ï¼šC&#x2F;C++ , cmake tools intelliSense</p></li><li><p>åœ¨archç”¨æˆ·ç›®å½•ä¸‹æ–°å»ºé¡¹ç›®ç›®å½•ï¼Œå¹¶åˆ›å»ºç¬¬ä¸€ä¸ªé¡¹ç›®ç›®å½•testï¼Œåœ¨é‡Œé¢æ–°å»ºæ–‡ä»¶test.cpp</p></li><li><p>.cppå¯¹åº”çš„ç¼–è¯‘å™¨é€‰æ‹©æ˜¯g++ï¼ˆä¸è¦é€‰é”™æˆgccï¼Œå¦åˆ™å°±ä¼šæ‰¾ä¸åˆ°c++åº“çš„å‡½æ•°std::coutï¼‰</p></li><li><p>å¦‚æœå¿˜äº†è£…makeæˆ–è€…ninjaçš„è¯ï¼Œbuild è¿è¡Œä¹‹åä¼šæŠ¥é”™</p><p>  <img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241353842.png" alt="CMake error"></p><ul><li><p>éœ€è¦å®‰è£…ninjaæˆ–è€…makeï¼›å¦‚æœæ˜¯ninjaï¼Œéœ€è¦è®¾ç½®cmakeçš„prefered generatorä¸ºninjaï¼›ä½†æ˜¯è²Œä¼¼uiè®¾ç½®çš„ä¸ä¸€å®šä¼šæ˜ å°„åˆ°jsoné‡Œé¢</p><p>  <img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241353447.png" alt="ca28d36c-a5cd-4f20-8d46-64c7284082d0.png"></p><p>  <img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241354483.png" alt="settings.json"></p><p>  Ref: <a href="https://zhuanlan.zhihu.com/p/7346544263">å¦‚ä½•åœ¨VSCodeä¸­â€œä¼˜é›…â€åœ°é…ç½®CMake â€”â€” ä»¥PaddlePaddleä¸ºä¾‹ - çŸ¥ä¹</a></p></li></ul></li><li><p>å…³äºvscodeä¸­çš„jsoné…ç½®ï¼ˆé¦–é€‰ç”¨UIè¿›è¡Œé€‰é¡¹é…ç½®ï¼‰</p><p>  <img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241354220.png" alt="d299a350-7aea-4a0f-b18e-8a7eafca7064.png"></p><p>  <img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202503241354293.png" alt="hello world"></p></li></ul><p>Ref: <a href="https://code.visualstudio.com/docs/cpp/config-linux">Using C++ on Linux in VS Code</a></p><p>Ref: <a href="https://code.visualstudio.com/docs/cpp/c-cpp-properties-schema-reference">c_cpp_properties.json reference</a></p><p>Ref: <a href="https://code.visualstudio.com/docs/cpp/cmake-linux">Get started with CMake Tools on Linux</a></p>]]></content>
    
    
    <categories>
      
      <category>éƒ¨ç½²manual</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wsl</tag>
      
      <tag>ArchLinux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>02.0.æ™ºèƒ½æŒ‡é’ˆä¸RAIIæ€æƒ³</title>
    <link href="/2024/10/28/RAII%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    <url>/2024/10/28/RAII%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="02-0-æ™ºèƒ½æŒ‡é’ˆä¸RAIIæ€æƒ³"><a href="#02-0-æ™ºèƒ½æŒ‡é’ˆä¸RAIIæ€æƒ³" class="headerlink" title="02.0.æ™ºèƒ½æŒ‡é’ˆä¸RAIIæ€æƒ³"></a>02.0.æ™ºèƒ½æŒ‡é’ˆä¸RAIIæ€æƒ³</h1><h2 id="ä¸å¯æ»¥ç”¨å°è£…â€”â€”å°è£…çš„ç›®çš„æ˜¯ç»´æŠ¤ç›¸å…³å±æ€§çš„ä¸å˜æ€§"><a href="#ä¸å¯æ»¥ç”¨å°è£…â€”â€”å°è£…çš„ç›®çš„æ˜¯ç»´æŠ¤ç›¸å…³å±æ€§çš„ä¸å˜æ€§" class="headerlink" title="ä¸å¯æ»¥ç”¨å°è£…â€”â€”å°è£…çš„ç›®çš„æ˜¯ç»´æŠ¤ç›¸å…³å±æ€§çš„ä¸å˜æ€§"></a>ä¸å¯æ»¥ç”¨å°è£…â€”â€”å°è£…çš„ç›®çš„æ˜¯ç»´æŠ¤ç›¸å…³å±æ€§çš„ä¸å˜æ€§</h2><p>æ­£é¢ä¾‹å­ï¼švector</p><ul><li>ç”±äºå¯¹å•ä¸ªå…ƒç´ çš„å¢åˆ æ“ä½œä¼šå½±å“åˆ°vectorçš„sizeä»¥åŠèµ„æºåˆ†é…å¤§å°ï¼Œå› æ­¤éœ€è¦æ‰“åŒ…æ“ä½œä½œä¸ºä¸€ä¸ªåŸå­ï¼ˆä¸å¯åˆ†å‰²ï¼‰æ¥é¿å…ç¨‹åºå‘˜ç–å¿½çŠ¯é”™</li></ul><p>åé¢ä¾‹å­ï¼šä¸‰å…ƒtupleä½¿ç”¨å°è£… (x)</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Vec3</span>&#123;<br><span class="hljs-type">float</span> x,y,z;<br>&#125;<br><span class="hljs-comment">// structè¶³å¤Ÿï¼Œä¸éœ€è¦classå’ŒgetX setXæ–¹æ³•</span><br></code></pre></td></tr></table></figure><ul><li>ä¸éœ€è¦å¯¹ä¸€ä¸ª<code>(x,y,z)</code>å†™<code>getter</code>å’Œ<code>setter</code>å› ä¸ºå½¼æ­¤æ˜¯ç‹¬ç«‹çš„</li></ul><h3 id="å°è£…ç±»â€”â€”æ„é€ å‡½æ•°"><a href="#å°è£…ç±»â€”â€”æ„é€ å‡½æ•°" class="headerlink" title="å°è£…ç±»â€”â€”æ„é€ å‡½æ•°"></a>å°è£…ç±»â€”â€”æ„é€ å‡½æ•°</h3><p>æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨member list initializer: </p><ul><li>constï¼Œreferenceæˆå‘˜å¿…é¡»åœ¨ç±»æ„é€ ä¹‹å‰åˆå§‹åŒ–ï¼Œå¿…é¡»ç”¨æˆå‘˜åˆ—è¡¨initialize</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> constantValue;       <span class="hljs-comment">// const æˆå‘˜</span><br>    std::string&amp; referenceMember;  <span class="hljs-comment">// å¼•ç”¨æˆå‘˜</span><br><br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// æ„é€ å‡½æ•°ï¼Œä½¿ç”¨æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨å¯¹ const å’Œå¼•ç”¨æˆå‘˜è¿›è¡Œåˆå§‹åŒ–</span><br>    <span class="hljs-built_in">MyClass</span>(<span class="hljs-type">int</span> value, std::string&amp; ref)<br>        : <span class="hljs-built_in">constantValue</span>(value), <span class="hljs-built_in">referenceMember</span>(ref) &#123;<br>        <span class="hljs-comment">// æ„é€ å‡½æ•°ä¸»ä½“</span><br>       <br>    &#125;<br></code></pre></td></tr></table></figure><ul><li>é¿å…é‡å¤åˆå§‹åŒ–ï¼Œæ›´é«˜æ•ˆ</li></ul><p><code>explicit</code>ä¿®é¥°æ„é€ å‡½æ•°:</p><ul><li>å•å‚æ•°æ—¶ï¼šç¦æ­¢éšå¼çš„ç±»å‹è½¬æ¢</li><li>å¤šå‚æ•°æ—¶ï¼šï¼ˆåŒå•å‚æ•°ï¼‰</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Pig</span> &#123;<br>    std::string m_name;<br>    <span class="hljs-type">int</span> m_weight;<br><br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Pig</span><span class="hljs-params">(std::string name, <span class="hljs-type">int</span> weight)</span></span><br><span class="hljs-function">        : m_name(name)</span><br><span class="hljs-function">        , m_weight(weight)</span><br><span class="hljs-function">    &#123;</span>&#125;<br><br>    <span class="hljs-built_in">Pig</span>(Pig <span class="hljs-type">const</span> &amp;other) = <span class="hljs-keyword">default</span>;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">(Pig pig)</span> </span>&#123;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;name: &quot;</span> &lt;&lt; pig.m_name &lt;&lt; std::endl;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;weight: &quot;</span> &lt;&lt; pig.m_weight &lt;&lt; std::endl;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">show</span>(&#123;<span class="hljs-string">&quot;pig1&quot;</span>,<span class="hljs-number">20</span>&#125;); <span class="hljs-comment">//ç¼–è¯‘ä¸é€šè¿‡ å¦‚æœå»æ‰explicit å¯ä»¥æ‰§è¡Œ</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æ³¨æ„ï¼šå¹¶ä¸æ˜¯ç»å¯¹çš„è¦alwaysåŠ ä¸Š<code>explicit</code> sometimeséœ€è¦éšå¼ç±»å‹è½¬æ¢å¸¦æ¥æ–¹ä¾¿å“¦</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// QString(const char *str); æ²¡æœ‰explicit æ‰€ä»¥æ”¯æŒéšå¼è½¬æ¢</span><br>QString str = <span class="hljs-string">&quot;Hello, world!&quot;</span>; <span class="hljs-comment">// éšå¼è½¬æ¢ const char* åˆ° QString</span><br></code></pre></td></tr></table></figure><p>Ref: <a href="https://en.cppreference.com/w/cpp/language/constructor">æ„é€ å‡½æ•°å’Œæˆå‘˜åˆå§‹å€¼è®¾å®šé¡¹åˆ—è¡¨ - cppreference.com â€” Constructors and member initializer lists - cppreference.com</a></p><p>() vs {}â€”â€”castç±»å‹å°å¿ƒä¸¢å¤±ç²¾åº¦:</p><ul><li>()å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œ{}æ›´åŠ å®‰å…¨</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">int</span>(<span class="hljs-number">3.14f</span>) <span class="hljs-comment">//ä¸å‡ºé”™</span><br><span class="hljs-type">int</span>&#123;<span class="hljs-number">3.14f</span>&#125; <span class="hljs-comment">//æŠ¥é”™ &#123;&#125;æ˜¯éå¼ºåˆ¶è½¬æ¢</span><br><span class="hljs-comment">//æ¨èä½¿ç”¨ï¼š</span><br><span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">3.14f</span>);<br><span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(<span class="hljs-number">0xb8000</span>);<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ç¼–è¯‘å™¨çš„å¯¹ç±»çš„é»˜è®¤æ„é€ å‡½æ•°æ—¶ï¼š</p><ul><li>è¿™äº›æˆå‘˜ç±»å‹ä¸ä¼šè¢«åˆå§‹åŒ–ä¸º 0ï¼š<ul><li>int, float, double ç­‰åŸºç¡€ç±»å‹</li><li>void *, Object * ç­‰æŒ‡é’ˆç±»å‹</li><li>å®Œå…¨ç”±è¿™äº›ç±»å‹ç»„æˆçš„ç±»</li></ul></li><li>è¿™äº›ç±»å‹è¢«ç§°ä¸º <strong>PODï¼ˆplain-old-dataï¼‰</strong></li></ul><p>åº”ç”¨ä¾‹å­â€”â€”å…‰çº¿è¿½è¸ªå‡½æ•°è¿”å›å€¼æœ‰å¤šä¸ªå±æ€§æ—¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">HitRes</span>&#123;<br><span class="hljs-type">bool</span> hit;<br>Vec3 pos;<br>Vec3 normal;<br><span class="hljs-type">float</span> depth;<br>&#125;;<br><span class="hljs-function">HitRes <span class="hljs-title">intersect</span><span class="hljs-params">(Ray r)</span> </span>&#123;<br><span class="hljs-keyword">return</span> &#123;<span class="hljs-literal">true</span>, r.origin, r.direction, <span class="hljs-number">233.0f</span>&#125;<br>&#125;<br><span class="hljs-comment">// or </span><br><span class="hljs-keyword">struct</span> HitRes&#123;<br><span class="hljs-type">bool</span> hit;<br>Vec3 pos;<br>Vec3 normal;<br><span class="hljs-type">float</span> depth;<br>&#125; <span class="hljs-built_in">intersect</span>(Ray r) &#123;<br><span class="hljs-keyword">return</span> &#123;<span class="hljs-literal">true</span>, r.origin, r.direction, <span class="hljs-number">233.0f</span>&#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-built_in">main</span>()&#123;<br>Ray r;<br><span class="hljs-keyword">auto</span> hit = <span class="hljs-built_in">intersect</span>(r);<br><span class="hljs-keyword">if</span>(hit.hit)&#123;<br>r.origin = hit.pos;<br>r.direction = hit.normal;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å’Œtupleç›¸æ¯”ï¼Œ{}ä¼šæœ‰åå­—</li></ul><h3 id="ä¸‰äº”æ³•åˆ™ï¼š"><a href="#ä¸‰äº”æ³•åˆ™ï¼š" class="headerlink" title="ä¸‰äº”æ³•åˆ™ï¼š"></a>ä¸‰äº”æ³•åˆ™ï¼š</h3><p>é€‚ç”¨äºç®¡ç†èµ„æºçš„ç±»ï¼ˆå¦‚diyçš„vectorç±»ï¼‰</p><ul><li>å¦‚æœä¸€ä¸ªç±»å®šä¹‰äº†è§£æ„å‡½æ•°ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»åŒæ—¶å®šä¹‰æˆ–åˆ é™¤æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼å‡½æ•°ï¼Œå¦åˆ™å‡ºé”™ã€‚</li><li>å¦‚æœä¸€ä¸ªç±»å®šä¹‰äº†æ‹·è´æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»åŒæ—¶å®šä¹‰æˆ–åˆ é™¤æ‹·è´èµ‹å€¼å‡½æ•°ï¼Œå¦åˆ™å‡ºé”™ï¼Œåˆ é™¤å¯å¯¼è‡´ä½æ•ˆã€‚</li><li>å¦‚æœä¸€ä¸ªç±»å®šä¹‰äº†ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»åŒæ—¶å®šä¹‰æˆ–åˆ é™¤ç§»åŠ¨èµ‹å€¼å‡½æ•°ï¼Œå¦åˆ™å‡ºé”™ï¼Œåˆ é™¤å¯å¯¼è‡´ä½æ•ˆã€‚</li><li>å¦‚æœä¸€ä¸ªç±»å®šä¹‰äº†æ‹·è´æ„é€ å‡½æ•°æˆ–æ‹·è´èµ‹å€¼å‡½æ•°ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»æœ€å¥½åŒæ—¶å®šä¹‰ç§»åŠ¨æ„é€ å‡½æ•°æˆ–ç§»åŠ¨èµ‹å€¼å‡½æ•°ï¼Œå¦åˆ™ä½æ•ˆã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">C</span>&#123;<br><span class="hljs-built_in">C</span>();<br><span class="hljs-built_in">C</span>(C <span class="hljs-type">const</span> &amp;c);<br><span class="hljs-built_in">C</span>(C &amp;&amp;c);<br>C &amp;<span class="hljs-keyword">operator</span>=(C <span class="hljs-type">const</span> &amp;c);<br>C &amp;<span class="hljs-keyword">operator</span>=(C &amp;&amp;c);<br>~<span class="hljs-built_in">C</span>();<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>ç”±äºè‡ªåŠ¨ç”Ÿæˆçš„æ‹·è´èµ‹å€¼å’Œæ„é€ å¯¹äºæ™ºèƒ½æŒ‡é’ˆæ˜¯æµ…æ‹·è´ å› æ­¤ä¸‹é¢æƒ…å†µå¯èƒ½ä¼šdouble free ç”šè‡³åˆ«çš„æƒ…å†µä¸­ï¼Œå¦‚æœvec2æå‰é‡Šæ”¾çš„è¯ï¼Œvec1æ˜¯æ‚¬å‚æŒ‡é’ˆdangling pointeræ›´åŠ å±é™©</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>Vector vec1;<br><span class="hljs-function">Vector <span class="hljs-title">vec2</span><span class="hljs-params">(vec1)</span></span>;<br>Vector vec3 = vec1;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// è‡ªåŠ¨é‡Šæ”¾vec1ï¼Œ2ï¼Œ3</span><br>&#125;<br></code></pre></td></tr></table></figure><ol><li><p>ä¸ºäº†ç»Ÿä¸€æ‹·è´æ—¶æ˜¯æ·±æ‹·è´ ç§»åŠ¨çš„æ—¶å€™ç»Ÿä¸€é€»è¾‘</p></li><li><p>ä¸ºäº†ç»Ÿä¸€æ‹·è´æ—¶æ˜¯æ·±æ‹·è´ ç§»åŠ¨çš„æ—¶å€™ç»Ÿä¸€é€»è¾‘</p></li><li><p>ç§»åŠ¨ä¼šæ›´é«˜æ•ˆ</p></li></ol><h2 id="æ™ºèƒ½æŒ‡é’ˆ"><a href="#æ™ºèƒ½æŒ‡é’ˆ" class="headerlink" title="æ™ºèƒ½æŒ‡é’ˆ"></a>æ™ºèƒ½æŒ‡é’ˆ</h2><h3 id="unique-ptr"><a href="#unique-ptr" class="headerlink" title="unique_ptr"></a>unique_ptr</h3><p>ä¸å¯ä»¥è¢«æ‹·è´ï¼Œå¦‚æœè¦ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°å¯é€‰æ‹©ï¼š</p><ul><li><code>func(p.get());</code> ç”¨äºä¸æ”¹å˜pçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸ä¼šæ¥ç®¡pçš„ownership<ul><li>ä½†æ˜¯éœ€è¦æ³¨æ„ä¸èƒ½åœ¨funcå†…éƒ¨å»é‡Šæ”¾æ‰pæŒ‡å‘çš„èµ„æº</li></ul></li><li><code>func(std::move(p));</code> ç”¨äºæ”¹å˜pçš„ç”Ÿå‘½å‘¨æœŸï¼ŒtakeåŸæœ¬çš„ownershipï¼ˆæ­¤æ—¶å¤–éƒ¨çš„på·²ç»æŒ‡å‘nullptrï¼‰</li></ul><h3 id="shared-ptr-å’Œ-weak-ptr"><a href="#shared-ptr-å’Œ-weak-ptr" class="headerlink" title="shared_ptr å’Œ weak_ptr"></a>shared_ptr å’Œ weak_ptr</h3><ul><li><code>C*</code> ç†è§£ä¸º <code>unique_ptr</code> çš„å¼±å¼•ç”¨ã€‚</li><li><code>weak_ptr</code> ç†è§£ä¸º <code>shared_ptr</code> çš„å¼±å¼•ç”¨ã€‚ä½† <code>weak_ptr</code> èƒ½æä¾›å¤±æ•ˆæ£€æµ‹ï¼Œæ›´å®‰å…¨ã€‚</li></ul><p>shared_ptrç»´æŠ¤çš„use_count</p><blockquote><p>In a typical implementation,Â <code>shared_ptr</code>Â holds only two pointers:åœ¨å…¸å‹çš„å®ç°ä¸­ï¼ŒÂ <code>shared_ptr</code>ä»…ä¿å­˜ä¸¤ä¸ªæŒ‡é’ˆï¼š</p><ul><li><p>the stored pointer (one returned byÂ <a href="https://en.cppreference.com/w/cpp/memory/shared_ptr/get">get()</a>);</p><p>å­˜å‚¨çš„æŒ‡é’ˆï¼ˆç”±<a href="https://en.cppreference.com/w/cpp/memory/shared_ptr/get">get()</a>è¿”å›çš„æŒ‡é’ˆï¼‰ï¼›</p></li><li><p>a pointer toÂ <em>control block</em>.</p><p>æŒ‡å‘<em>æ§åˆ¶å—çš„</em>æŒ‡é’ˆã€‚{control blockåŒ…å«ï¼š</p><ul><li><p>either a pointer to the managed object or the managed object itself;</p><p>æŒ‡å‘æ‰˜ç®¡å¯¹è±¡çš„æŒ‡é’ˆæˆ–æ‰˜ç®¡å¯¹è±¡æœ¬èº«ï¼›</p></li><li><p>the deleter (type-erased);</p><p>åˆ é™¤å™¨ï¼ˆç±»å‹æ“¦é™¤ï¼‰ï¼›</p></li><li><p>the allocator (type-erased);</p><p>åˆ†é…å™¨ï¼ˆç±»å‹æ“¦é™¤ï¼‰ï¼›</p></li><li><p>the number ofÂ <code>shared_ptr</code>s that own the managed object;</p><p>æ‹¥æœ‰æ‰˜ç®¡å¯¹è±¡çš„<code>shared_ptr</code>çš„æ•°é‡ï¼›</p></li><li><p>the number ofÂ <code>weak_ptr</code>s that refer to the managed object.</p><p>å¼•ç”¨æ‰˜ç®¡å¯¹è±¡çš„<code>weak_ptr</code>çš„æ•°é‡ã€‚</p><p>}</p></li></ul></li></ul></blockquote><p>Ref: <a href="https://en.cppreference.com/w/cpp/memory/shared_ptr">std::shared_ptr - cppreference.com â€” std::shared_ptr - cppreference.com</a></p><ul><li>åˆ›å»ºè‡ªèº«æ—¶: +1</li><li>è¢«å…¶ä»–å¯¹è±¡æŒæœ‰æˆ–è€…æ‹·è´ç»™äº†å¦ä¸€ä¸ªshared_ptr: +1</li></ul><p>åªæœ‰å½“æ‰€æœ‰æŒ‡å‘è¯¥å¯¹è±¡çš„ <code>shared_ptr</code> è¢«é”€æ¯ï¼Œå¼•ç”¨è®¡æ•°é™ä¸º 0 æ—¶ï¼Œæ§åˆ¶å—æ‰ä¼šé”€æ¯å¯¹è±¡ã€‚</p><p><strong>å¦‚ä½•è®©ä¸€ä¸ªweak_ptræŒ‡å‘ä¸€ä¸ªNodeçš„æŒ‡é’ˆ</strong></p><ul><li>weak_ptrå¯ä»¥æŒ‡å‘shared_ptr</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span> : std::enable_shared_from_this&lt;Node&gt;&#123;<br>    std::shared_ptr&lt;Node&gt; next;<br>    std::weak_ptr&lt;Node&gt; prev;<br>    <span class="hljs-type">int</span> value;<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Node</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> </span>&#123;<br>        value = val;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> </span>&#123;<br>        <span class="hljs-keyword">auto</span> node = std::<span class="hljs-built_in">make_shared</span>&lt;Node&gt;(val);<br>        node-&gt;prev = <span class="hljs-built_in">shared_from_this</span>();<br>        node-&gt;next = next;<br>        <span class="hljs-keyword">this</span>-&gt;next = node;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">erase</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (next)<br>            next-&gt;prev = prev;<br>        <span class="hljs-keyword">if</span> (!prev.<span class="hljs-built_in">expired</span>()) &#123;<br>            prev.<span class="hljs-built_in">lock</span>()-&gt;next= next;  <br>        &#125;<br>    &#125;<br><br>    ~<span class="hljs-built_in">Node</span>() &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;~Node()\n&quot;</span>);   <br>    &#125;<br>&#125;;<br><br><span class="hljs-keyword">auto</span> node_weak = std::<span class="hljs-built_in">weak_ptr</span>&lt;Node&gt;();<br>node_weak = node1;<br>std::cout &lt;&lt; node_weak.<span class="hljs-built_in">lock</span>()-&gt;value &lt;&lt; std::endl;<br></code></pre></td></tr></table></figure><ul><li>weak_pträ¸å¯ä»¥æŒ‡å‘ä¸€ä¸ªè£¸objectæŒ‡é’ˆ</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span> : std::enable_shared_from_this&lt;Node&gt;&#123;<br>    <span class="hljs-comment">// enable sharedä½¿å¾—å¯ä»¥è·å–objectçš„sharedæŒ‡é’ˆ</span><br>    std::shared_ptr&lt;Node&gt; next;<br>    std::weak_ptr&lt;Node&gt; prev;<br><br>    <span class="hljs-type">int</span> value;<br><br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Node</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> </span>&#123;<br>        value = val;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> </span>&#123;<br><span class="hljs-keyword">auto</span> node = std::<span class="hljs-built_in">make_shared</span>&lt;Node&gt;(val);<br><span class="hljs-comment">// node-&gt;prev = std::shared_ptr&lt;Node&gt;(this); //é…±ç´«ä¼šæŠ¥é”™</span><br><span class="hljs-comment">// node-&gt;next = this; //é…±ç´«ä¸è¿‡ç¼–è¯‘ No viable operator= matches arguments of type std::shared_ptr&lt;Node&gt; and Node *.</span><br>  node-&gt;next = next;<br>  <span class="hljs-keyword">this</span>-&gt;next = node;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>std::weak_ptr</code>Â is a smart pointer that holds a non-owning (â€œweakâ€) reference to an object that is managed byÂ <a href="https://en.cppreference.com/w/cpp/memory/shared_ptr">std::shared_ptr</a>. It must be converted toÂ <a href="https://en.cppreference.com/w/cpp/memory/shared_ptr">std::shared_ptr</a>Â in order to access the referenced object.</p></blockquote><p>Ref: <a href="https://en.cppreference.com/w/cpp/memory/weak_ptr">std::weak_ptr - cppreference.com â€” std::weak_ptr - cppreference.com</a></p><blockquote><p>åœ¨ç±»å†…éƒ¨å¦‚æœéœ€è¦è·å–å½“å‰å¯¹è±¡çš„ <code>shared_ptr</code>ï¼Œåº”è¯¥ä½¿ç±»ç»§æ‰¿ <strong><code>std::enable_shared_from_this</code></strong></p></blockquote><p>Ref: <a href="https://stackoverflow.com/questions/712279/what-is-the-usefulness-of-enable-shared-from-this">c++ - <code>enable_shared_from_this</code> æœ‰ä»€ä¹ˆç”¨å¤„ï¼Ÿ - å †æ ˆæº¢å‡º â€” c++ - What is the usefulness of <code>enable_shared_from_this</code>? - Stack Overflow</a></p><p><a href="https://learn.microsoft.com/en-us/cpp/standard-library/enable-shared-from-this-class?view=msvc-170">å¯ç”¨_shared_from_this ç±» |å¾®è½¯å­¦ä¹  â€” enable_shared_from_this Class | Microsoft Learn</a></p><ul><li>æ­£é¢ä¾‹å­ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> : <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;MyClass&gt; &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">std::shared_ptr&lt;MyClass&gt; <span class="hljs-title">getSharedPtr</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">shared_from_this</span>(); <span class="hljs-comment">// ä½¿ç”¨ enable_shared_from_this çš„æ­£ç¡®æ–¹å¼</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;MyClass instance&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// æ­£ç¡®æ–¹å¼ï¼šä½¿ç”¨ std::make_shared åˆ›å»º shared_ptr</span><br>    std::shared_ptr&lt;MyClass&gt; obj1 = std::<span class="hljs-built_in">make_shared</span>&lt;MyClass&gt;();<br><br>    <span class="hljs-comment">// ä½¿ç”¨æˆå‘˜å‡½æ•°åˆ›å»ºå¦ä¸€ä¸ªå…±äº«çš„ shared_ptr</span><br>    std::shared_ptr&lt;MyClass&gt; obj2 = obj1-&gt;<span class="hljs-built_in">getSharedPtr</span>();<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;obj1 address&quot;</span> &lt;&lt; obj1.<span class="hljs-built_in">get</span>() &lt;&lt; std::endl; <br>    std::cout &lt;&lt; <span class="hljs-string">&quot;obj2 address&quot;</span> &lt;&lt; obj2.<span class="hljs-built_in">get</span>() &lt;&lt; std::endl; <span class="hljs-comment">//æ˜¯ä¸€æ ·çš„</span><br>    <span class="hljs-comment">// è¾“å‡ºå¼•ç”¨è®¡æ•°</span><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;obj1 use_count: &quot;</span> &lt;&lt; obj1.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// è¾“å‡º 2</span><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;obj2 use_count: &quot;</span> &lt;&lt; obj2.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// è¾“å‡º 2</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>è¿™ç§ä¸œä¸œä¸ä¼šé€ æˆå¾ªç¯å¼•ç”¨ï¼Œ<code>obj1</code>å’Œ<code>obj2</code>çš„å…³ç³»å¹¶éäº’ç›¸æŒæœ‰ï¼Œè€Œæ˜¯å…±åŒæ‹¥æœ‰æ§åˆ¶å—<ul><li>å¯ä»¥ç®€å•çš„ç†è§£ä¸ºè¿™æ˜¯<code>shared_ptr</code>å‘ç”Ÿäº†æ‹·è´è¡Œä¸º</li></ul></li><li>åé¢ä¾‹å­ï¼š(x)</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">std::shared_ptr&lt;MyClass&gt; <span class="hljs-title">getSharedPtr</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt;(<span class="hljs-keyword">this</span>); <span class="hljs-comment">// é”™è¯¯ï¼šç›´æ¥ç”¨ this åˆ›å»ºæ–°çš„ shared_ptr</span><br>&#125;<br><span class="hljs-comment">// ç»Ÿä¸€ç”¨shared_ptrçš„å†™æ³•ä¿è¯äº†debugè§†å›¾control blockæ˜¾ç¤ºçš„ä¸€è‡´</span><br>std::shared_ptr&lt;MyClass&gt; obj1 = std::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt;(<span class="hljs-keyword">new</span> MyClass);<br>std::shared_ptr&lt;MyClass&gt; obj2 = obj1-&gt;<span class="hljs-built_in">getSharedPtr</span>();<br><br>std::cout &lt;&lt; <span class="hljs-string">&quot;obj1 address&quot;</span> &lt;&lt; obj1.<span class="hljs-built_in">get</span>() &lt;&lt; std::endl; <br>std::cout &lt;&lt; <span class="hljs-string">&quot;obj2 address&quot;</span> &lt;&lt; obj2.<span class="hljs-built_in">get</span>() &lt;&lt; std::endl; <span class="hljs-comment">//æ˜¯ä¸€æ ·çš„</span><br><span class="hljs-comment">// è¾“å‡ºå¼•ç”¨è®¡æ•°</span><br>std::cout &lt;&lt; <span class="hljs-string">&quot;obj1 use_count: &quot;</span> &lt;&lt; obj1.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// è¾“å‡º 1</span><br>std::cout &lt;&lt; <span class="hljs-string">&quot;obj2 use_count: &quot;</span> &lt;&lt; obj2.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// è¾“å‡º 1</span><br></code></pre></td></tr></table></figure><h2 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h2><h3 id="ä¸ç»§æ‰¿enabled-shared-from-this-ä¼å›¾ä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªshared-ptr-x"><a href="#ä¸ç»§æ‰¿enabled-shared-from-this-ä¼å›¾ä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªshared-ptr-x" class="headerlink" title="ä¸ç»§æ‰¿enabled_shared_from_this ä¼å›¾ä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªshared_ptr(x)"></a>ä¸ç»§æ‰¿<code>enabled_shared_from_this</code> ä¼å›¾ä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªshared_ptr(x)</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">std::shared_ptr&lt;MyClass&gt; <span class="hljs-title">getSharedPtr</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt;(<span class="hljs-keyword">this</span>); <span class="hljs-comment">// é”™è¯¯ï¼šç›´æ¥ç”¨ this åˆ›å»ºæ–°çš„ shared_ptr</span><br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;MyClass instance&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    std::shared_ptr&lt;MyClass&gt; obj1 = std::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt;(<span class="hljs-keyword">new</span> MyClass);<br>    <span class="hljs-comment">// ä½¿ç”¨æˆå‘˜å‡½æ•°åˆ›å»ºå¦ä¸€ä¸ªå…±äº«çš„ shared_ptr</span><br>    std::shared_ptr&lt;MyClass&gt; obj2 = obj1-&gt;<span class="hljs-built_in">getSharedPtr</span>();<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052011146.png" alt="image.png"></p><p><code>_Rep</code>æ˜¯æ§åˆ¶å—</p><p>Ref: <a href="https://devblogs.microsoft.com/oldnewthing/20230814-00/?p=108597#:~:text=0x00c%20_Weaks%20%20%20%20%20%20%20%20%20%20%20%3A%201-,Here%E2%80%99s,-how%20the%20names">Inside STL: Smart pointers - The Old New Thing</a></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052011332.png" alt="image.png"></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052013138.png" alt="image.png"></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052011876.png" alt="image.png"></p><ul><li>æ³¨æ„åˆ°ï¼Œ<code>obj1</code>å’Œ<code>obj2</code>çš„æ§åˆ¶å—å¹¶ä¸ç›¸åŒï¼Œå½¼æ­¤å¹¶ä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚èµ„æº<code>_Ptr</code>åªæœ‰ä¸€ä»½ï¼Œå½“å„è‡ªçš„å¼•ç”¨è®¡æ•°&#x3D;0æ—¶éƒ½ä¼šå»åˆ é™¤èµ„æºï¼Œå¯¼è‡´double freeï¼Œé“¸æˆå¤§é”™:(</li><li>å¤šä¸ªshared_ptrå„è‡ªåˆå§‹åŒ–å¹¶æŒ‡å‘åŒä¸€ä¸ªèµ„æºè¿åäº†rulesï¼š</li></ul><blockquote><p>The ownership of an object can <strong>only be</strong> shared with another<code>shared_ptr</code>by copy constructing or copy assigning its value to another<code>shared_ptr</code>. Constructing a new<code>shared_ptr</code>using the raw underlying pointer owned by another<code>shared_ptr</code>leads to undefined behavior.</p><p>å¯¹è±¡çš„æ‰€æœ‰æƒåªèƒ½é€šè¿‡å¤åˆ¶æ„é€ æˆ–å¤åˆ¶å°†å…¶å€¼åˆ†é…ç»™å¦ä¸€ä¸ª<code>shared_ptr</code>Â <code>shared_ptr</code>Â ã€‚ä½¿ç”¨å¦ä¸€ä¸ª<code>shared_ptr</code>æ‹¥æœ‰çš„åŸå§‹åº•å±‚æŒ‡é’ˆæ„é€ ä¸€ä¸ªæ–°çš„<code>shared_ptr</code>ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚</p></blockquote><p>Ref: <a href="https://en.cppreference.com/w/cpp/memory/shared_ptr">std::shared_ptr - cppreference.com â€” std::shared_ptr - cppreference.com</a></p><p><em><strong>Sidenoteâ€”â€”double freeä¸ºä»€ä¹ˆåï¼Ÿ</strong></em></p><ul><li>å¤§å¤šæ•°å†…å­˜åˆ†é…å™¨ï¼ˆä¾‹å¦‚ GNU C åº“çš„ <code>malloc</code> å®ç°ï¼‰ä¸­ï¼Œæ¯ä¸ªå†…å­˜å—ï¼ˆchunkï¼‰çš„å…ƒæ•°æ®é€šå¸¸å­˜å‚¨åœ¨å—çš„å‰é¢å‡ ä¸ªå­—èŠ‚ä¸­ï¼Œç”¨äºè®°å½•å—çš„å¤§å°ã€åˆ†é…çŠ¶æ€ç­‰ä¿¡æ¯ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ<code>malloc</code> ä¼šåœ¨ç”¨æˆ·è¯·æ±‚çš„å†…å­˜å—å‰é¢ä¿ç•™é¢å¤–çš„å­—èŠ‚æ¥å­˜å‚¨è¿™äº›å…ƒæ•°æ®ï¼Œä¾‹å¦‚å—å¤§å°å’Œå…¶ä»–æ ‡è®°ä¿¡æ¯ã€‚</li><li>å½“double freeçš„æ—¶å€™ï¼Œè¢«freeçš„å†…å­˜chunkçš„sizeå‡è®¾æ˜¯å­˜å‚¨åœ¨ptrçš„å‰é¢å‡ ä¸ªå­—èŠ‚çš„ï¼Œä¾‹å¦‚<code>auto size = *(ptr - 8);</code> ç„¶åç¬¬ä¸€æ¬¡freeä¹‹åè¿™ä¸ª<code>ptr</code>å·²ç»æ— æ•ˆäº†ï¼Œç¬¬äºŒæ¬¡freeæ—¶å †ptr-8 çš„è§£å¼•ç”¨ å¯èƒ½ä¼šé€ æˆéæ³•å†…å­˜è®¿é—®</li></ul><h3 id="ä¸åŒshared-ptråˆ›å»ºæ–¹å¼â†’ä¸åŒçš„å†…å­˜å¸ƒå±€-layout"><a href="#ä¸åŒshared-ptråˆ›å»ºæ–¹å¼â†’ä¸åŒçš„å†…å­˜å¸ƒå±€-layout" class="headerlink" title="ä¸åŒshared_ptråˆ›å»ºæ–¹å¼â†’ä¸åŒçš„å†…å­˜å¸ƒå±€(layout)"></a><strong>ä¸åŒshared_ptråˆ›å»ºæ–¹å¼â†’ä¸åŒçš„å†…å­˜å¸ƒå±€(layout)</strong></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">std::shared_ptr&lt;MyClass&gt; <span class="hljs-title">getSharedPtr</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt;(<span class="hljs-keyword">this</span>); <span class="hljs-comment">// é”™è¯¯ï¼šç›´æ¥ç”¨ this åˆ›å»ºæ–°çš„ shared_ptr</span><br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;MyClass instance&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    std::shared_ptr&lt;MyClass&gt; obj1 = std::<span class="hljs-built_in">make_shared</span>&lt;MyClass&gt;();<br>    <span class="hljs-comment">// ä½¿ç”¨æˆå‘˜å‡½æ•°åˆ›å»ºå¦ä¸€ä¸ªå…±äº«çš„ shared_ptr</span><br>    std::shared_ptr&lt;MyClass&gt; obj2 = obj1-&gt;<span class="hljs-built_in">getSharedPtr</span>();<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052011662.png" alt="image.png"></p><ul><li><p>shared_ptrï¼šåˆ†åˆ«ç»™control block å’Œ raw pointeråˆ†é…</p></li><li><p>make_sharedï¼šä¸€æ¬¡æ€§åˆ†é…å †ç©ºé—´ï¼ˆä¼¼ä¹æ€§èƒ½å’Œå®‰å…¨ä¸Šæ›´å¥½ï¼‰</p></li><li><h4 id="ä¸åŒçš„æ„é€ æ–¹å¼å°†å¯¼è‡´ä¸åŒçš„å†…å­˜å¸ƒå±€ï¼ŒåŒæ—¶å½±å“shared-ptré”€æ¯æ—¶çš„å…·ä½“è¡Œä¸º"><a href="#ä¸åŒçš„æ„é€ æ–¹å¼å°†å¯¼è‡´ä¸åŒçš„å†…å­˜å¸ƒå±€ï¼ŒåŒæ—¶å½±å“shared-ptré”€æ¯æ—¶çš„å…·ä½“è¡Œä¸º" class="headerlink" title="ä¸åŒçš„æ„é€ æ–¹å¼å°†å¯¼è‡´ä¸åŒçš„å†…å­˜å¸ƒå±€ï¼ŒåŒæ—¶å½±å“shared_ptré”€æ¯æ—¶çš„å…·ä½“è¡Œä¸º"></a>ä¸åŒçš„æ„é€ æ–¹å¼å°†å¯¼è‡´ä¸åŒçš„å†…å­˜å¸ƒå±€ï¼ŒåŒæ—¶å½±å“<code>shared_ptr</code>é”€æ¯æ—¶çš„å…·ä½“è¡Œä¸º</h4><table><thead><tr><th>æƒ…å†µ</th><th>Dispose()</th><th>Delete()</th></tr></thead><tbody><tr><td>é€šè¿‡è£¸æŒ‡é’ˆä¼ å‚æ„é€ </td><td>é”€æ¯ S å¯¹è±¡å¹¶é‡Šæ”¾å¯¹è±¡å†…å­˜</td><td>é”€æ¯æ§åˆ¶å—å¹¶é‡Šæ”¾æ§åˆ¶å—å†…å­˜</td></tr><tr><td>é€šè¿‡ <code>make_shared</code> åˆ›å»º</td><td>è¿è¡Œ S å¯¹è±¡çš„ææ„å‡½æ•°ï¼ˆé‡Šæ”¾å¯¹è±¡å†…éƒ¨èµ„æºï¼‰ä½†ä¸é‡Šæ”¾å†…å­˜</td><td>é”€æ¯æ§åˆ¶å—å¹¶é‡Šæ”¾æ•´ä¸ªå†…å­˜å—ï¼ˆåŒ…å«å¯¹è±¡å’Œæ§åˆ¶å—ï¼‰</td></tr></tbody></table><p>è¿™é‡Œå¯èƒ½ä¼šæœ‰åŒå­¦å¥½å¥‡<code>Dispose()</code>å’Œ<code>Delete()</code>éƒ½æ˜¯ä»€ä¹ˆç©æ„å„¿</p><p>è«æ€¥ï¼Œè«æ€¥ï¼Œä¸”å¬æˆ‘ç»†ç»†é“æ¥</p><p><code>Dispose()</code>å’Œ<code>Delete()</code>æ˜¯<code>Control Block</code>çš„ä¸¤ä¸ªå‡½æ•°ï¼Œç”¨äºæ§åˆ¶ä¸¤ä¸ªä¸åŒé˜¶æ®µçš„é€’è¿›é”€æ¯è¡Œä¸º</p><ul><li><code>Dispose()</code>: è¯¥å‡½æ•°åœ¨æœ€åä¸€ä¸ª<code>shared_ptr</code>ææ„æ—¶è¢«è°ƒç”¨ï¼ˆaka, shareè®¡æ•°ä¸º0ï¼‰ï¼Œç”¨ä»¥ææ„è¢«<strong>ç®¡ç†çš„å¯¹è±¡</strong>æŒ‡é’ˆï¼ˆä½†ä¸ä¸€å®šå›æ”¶å†…å­˜ï¼‰</li><li><code>Delete()</code>: è¯¥å‡½æ•°åœ¨æ‰€æœ‰å…³è”çš„<code>shared_ptr</code>å’Œ<code>weak_ptr</code>å‡ææ„æ—¶è¢«è°ƒç”¨ï¼ˆaka, shareè®¡æ•°å’Œweakè®¡æ•°å‡å½’é›¶ï¼‰ï¼Œç”¨ä»¥å›æ”¶<strong>æ§åˆ¶å—</strong></li></ul><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿™ä¸¤ä¸ªé˜¶æ®µæ˜¯é€’è¿›å…³ç³»ï¼Œ<code>Dispose()</code>ä¿ç•™æ§åˆ¶å—çš„å”¯ä¸€ç†ç”±å°±æ˜¯æ€•æœ‰<code>weak_ptr</code>æƒ¦è®°ï¼Œä½†å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°åº”è¯¥å‡ ä¹ä¼šåŒæ­¥é¡ºåºæ‰§è¡Œ</p><p>è¿™æ ·ä¸€æ¥ï¼Œä¸Šæ–‡çš„è¡¨æ ¼ç›¸ä¿¡å„ä½å®¢å®˜éƒ½å·²ç»å¿ƒçŸ¥è‚šæ˜äº†</p><p>åœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œ<code>shared_ptr</code>é€šè¿‡è£¸æŒ‡é’ˆæ„é€ ï¼Œç”±äºè¢«ç®¡ç†çš„å¯¹è±¡å…ˆäº<code>shared_ptr</code>è¢«åˆ›å»ºï¼Œä»–ä»¬çš„å†…å­˜åˆ†å¸ƒæƒ³å¿…ä¹Ÿæ˜¯æ²¡ä»€ä¹ˆè”ç³»ï¼Œé‚£ä¹ˆåœ¨<code>Dispose()</code>æ—¶å³å¯å›æ”¶å…¶å†…å­˜</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411061424979.png" alt="é€šè¿‡shared_ptråˆ›å»º"></p><p>è€Œåœ¨ç¬¬äºŒç§æƒ…å†µä¸‹ï¼Œ<strong>è¢«ç®¡ç†çš„å¯¹è±¡</strong>ä»¥åŠ<code>shared_ptr</code>å‡é€šè¿‡ <code>make_shared</code>åˆ›å»ºï¼Œé‚£ä¹ˆå‡ºäºä¼˜åŒ–è€ƒè™‘ï¼Œ<strong>æ§åˆ¶å—</strong>å’Œ<strong>è¢«ç®¡ç†çš„å¯¹è±¡</strong>æ˜¯ä¸æ˜¯å¯ä»¥åœ¨ç»Ÿä¸€åˆ†é…çš„<strong>å¤§å—å†…å­˜</strong>ä¸Šæ„é€ å‘¢</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411061424217.png" alt="é€šè¿‡make_sharedåˆ›å»º"></p><p>æ˜¯çš„ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹ï¼Œ<code>Dispose()</code>è‚¯å®šä¹Ÿå°±ä¸èƒ½å•ç‹¬å›æ”¶è¯¥å¯¹è±¡æ‰€å ç”¨çš„éƒ¨åˆ†å†…å­˜ï¼Œå¿…é¡»ç­‰åˆ°<code>Delete()</code>æ—¶ï¼Œææ„æ§åˆ¶å—åï¼Œç»Ÿä¸€å›æ”¶æ•´ä½“å†…å­˜</p><p>è¯¦æƒ…è¯·è§ï¼š<a href="https://devblogs.microsoft.com/oldnewthing/20230815-00/?p=108602">Inside STL: The shared_ptr constructor vs make_shared - The Old New Thing</a></p></li><li><p>é”€æ¯æ—¶å¦‚ä½•é‡Šæ”¾ï¼Ÿ</p><ul><li>è¯·å‚è€ƒï¼š <a href="https://devblogs.microsoft.com/oldnewthing/20230815-00/?p=108602">STL å†…éƒ¨ï¼šshared_ptr æ„é€ å‡½æ•°ä¸ make_shared - è€æ–°äº‹ç‰© â€” Inside STL: The shared_ptr constructor vs make_shared - The Old New Thing</a></li></ul></li></ul><h3 id="å®éªŒä¹‹å‰â€”â€”é¢„ä¹ å¦‚ä½•çœ‹MSVCè°ƒè¯•å†…å­˜åœ°å€-â—â€™â—¡â€™â—"><a href="#å®éªŒä¹‹å‰â€”â€”é¢„ä¹ å¦‚ä½•çœ‹MSVCè°ƒè¯•å†…å­˜åœ°å€-â—â€™â—¡â€™â—" class="headerlink" title="å®éªŒä¹‹å‰â€”â€”é¢„ä¹ å¦‚ä½•çœ‹MSVCè°ƒè¯•å†…å­˜åœ°å€(â—â€™â—¡â€™â—)"></a>å®éªŒä¹‹å‰â€”â€”é¢„ä¹ å¦‚ä½•çœ‹MSVCè°ƒè¯•å†…å­˜åœ°å€(â—â€™â—¡â€™â—)</h3><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052011121.png" alt="image.png"></p><p>ç³»ç»Ÿæ¶æ„æ˜¯ 64 ä½ç³»ç»Ÿï¼Œå› æ­¤ <code>_Ptr</code> æŒ‡é’ˆå ç”¨ <strong>8 å­—èŠ‚</strong> çš„å†…å­˜ç©ºé—´ï¼Œä» <code>0x0000014289647130</code> åˆ° <code>0x0000014289647138</code></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052011100.png" alt="image.png"></p><ul><li>ç¬¬ä¸€è¡Œä»¥ <code>0x000001a4a9b023b0</code> å¼€å§‹ï¼Œç¬¬äºŒè¡Œä»¥ <code>0x000001a4a9b023c0</code> å¼€å§‹ã€‚</li><li>æ¯ä¸€è¡Œçš„å†…å­˜åœ°å€ç›¸å·® <strong>16 å­—èŠ‚</strong>ï¼ˆæˆ– 0x10ï¼‰ï¼Œè¿™è¡¨ç¤ºæ¯è¡Œæ˜¾ç¤ºçš„æ˜¯è¿ç»­çš„ 16 å­—èŠ‚çš„æ•°æ®ã€‚</li></ul><h3 id="shared-ptr-åˆ›å»ºæ–¹å¼"><a href="#shared-ptr-åˆ›å»ºæ–¹å¼" class="headerlink" title="shared_ptr åˆ›å»ºæ–¹å¼"></a><code>shared_ptr</code> åˆ›å»ºæ–¹å¼</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-type">int</span> value;<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> </span>&#123;<br>        value = val;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;Test object created.\n&quot;</span>;<br>    &#125;<br>    ~<span class="hljs-built_in">Test</span>() &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;Test object destroyed.\n&quot;</span>;<br>    &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    Test* rawPtr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Test</span>(<span class="hljs-number">1</span>);                       <br>    <span class="hljs-function">std::shared_ptr&lt;Test&gt; <span class="hljs-title">sp1</span><span class="hljs-params">(rawPtr)</span></span>;<br>    std::weak_ptr&lt;Test&gt; wp2;<br>    wp2 = sp1;<br>    sp1.<span class="hljs-built_in">reset</span>();<br>    std::cout &lt;&lt; wp2.<span class="hljs-built_in">lock</span>()-&gt;value &lt;&lt;std::endl; <span class="hljs-comment">//è¿è¡Œæ—¶é”™è¯¯ï¼Œè®¿é—®ä¸åˆ°value</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012503.png" alt="image.png"></p><ul><li>å¯ä»¥å‘ç°raw ptrå’Œcontrol blockçš„å†…å­˜åœ°å€å¹¶ä¸ç›¸é‚»</li></ul><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012493.png" alt="raw ptr å†…å­˜åœ°å€"></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012654.png" alt="control block (_Rep) å†…å­˜åœ°å€"></p><ul><li>å¯ä»¥å‘ç°control blockåé¢å­˜äº†ä¸€ä¸ªraw ptrçš„åœ°å€</li></ul><p><code>sp1.reset();</code> æ‰§è¡Œä¹‹å</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012639.png" alt="image.png"></p><p>ä¸‹å›¾æ˜¯weak ptré‡Œé¢çš„<code>_Rep</code>è§†å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012604.png" alt="control blockçš„Usesè®¡æ•° = 0  Weaksè®¡æ•° - 1 = 1"></p><p>ä¸‹å›¾æ˜¯weak ptré‡Œé¢çš„raw ptrè§†å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012947.png" alt="raw ptr å·²ç»å…ˆäºcontrol blockè¢«é‡Šæ”¾äº†èµ„æºäº†"></p><p><strong>ä¸ºä»€ä¹ˆè®¿é—®ä¸åˆ°valueï¼Ÿ</strong></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012630.png" alt="expired()è¡¨ç¤ºdyingå’Œdeadï¼ˆå¿«è¦é‡Šæ”¾å’Œå·²ç»åˆ é™¤é‡Šæ”¾ï¼‰"></p><p><code>Test</code> å¯¹è±¡å·²ç»ä¼¼äº†QAQï¼Œè¿åŒtaåœ°å€å‰é¢çš„å†…å­˜chunkï¼Œéƒ½æ˜¯taæ­»äº¡çš„è¯æ˜ï¼</p><h3 id="make-shared-åˆ›å»ºæ–¹å¼"><a href="#make-shared-åˆ›å»ºæ–¹å¼" class="headerlink" title="make_shared åˆ›å»ºæ–¹å¼"></a><code>make_shared</code> åˆ›å»ºæ–¹å¼</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-type">int</span> value;<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> </span>&#123;<br>        value = val;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;Test object created.\n&quot;</span>;<br>    &#125;<br>    ~<span class="hljs-built_in">Test</span>() &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;Test object destroyed.\n&quot;</span>;<br>    &#125;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    std::shared_ptr&lt;Test&gt; sp3 = std::<span class="hljs-built_in">make_shared</span>&lt;Test&gt;(<span class="hljs-number">1</span>);<br>    std::weak_ptr&lt;Test&gt; w4 = sp3;<br>    sp3.<span class="hljs-built_in">reset</span>();<br>    <span class="hljs-comment">// std::cout &lt;&lt; w4.lock()-&gt;value &lt;&lt; std::endl; //æ— æ³•è®¿é—®åˆ°</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012442.png" alt="image.png"></p><ul><li>å¯ä»¥å‘ç°raw ptrå’Œcontrol blockçš„å†…å­˜åœ°å€æ˜¯ç›¸é‚»çš„</li></ul><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012147.png" alt="raw ptrçš„å†…å­˜åœ°å€ä½ç½®å°±åœ¨control blockä¸‹æ–¹"></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012419.png" alt="control blockå†…å­˜åœ°å€"></p><p>å½“æ‰§è¡Œäº†<code>sp3.reset()**;</code>** å</p><p>weak ptrçš„raw ptrè§†å›¾</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012495.png" alt="image.png"></p><p>weak ptrçš„control blockè§†å›¾</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052012728.png" alt="image.png"></p><p><strong>ä¸ºä»€ä¹ˆè®¿é—®ä¸åˆ°valueï¼Ÿ</strong></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052013497.png" alt="è™½ç„¶æ­¤æ—¶å†…å­˜çš„valueæ˜¯1æ²¡é”™ï¼Œä½†Testå·²ç»è¡Œå°†å°±æœ¨"></p><blockquote><p><code>expired()</code> is equivalent toÂ <code>use_count()Â ==Â 0</code>. The destructor for the managed object may not yet have been called, but this objectâ€™s destruction is imminent (or may have already happened).ç›¸å½“äºuse_countÂ (Â )Â &#x3D;&#x3D;Â 0Â ã€‚æ‰˜ç®¡å¯¹è±¡çš„ææ„å‡½æ•°å¯èƒ½å°šæœªè¢«è°ƒç”¨ï¼Œä½†è¯¥å¯¹è±¡çš„é”€æ¯å³å°†å‘ç”Ÿï¼ˆæˆ–è€…å¯èƒ½å·²ç»å‘ç”Ÿï¼‰ã€‚</p></blockquote><p>Ref: <a href="https://en.cppreference.com/w/cpp/memory/weak_ptr/expired">std::weak_ptr<T> ::å·²è¿‡æœŸ - cppreference.com â€” std::weak_ptr<T>::expired - cppreference.com</a></p><h3 id="ä½¿ç”¨shared-from-this-âˆš"><a href="#ä½¿ç”¨shared-from-this-âˆš" class="headerlink" title="ä½¿ç”¨shared_from_this (âˆš)"></a>ä½¿ç”¨shared_from_this (âˆš)</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> : <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;MyClass&gt; &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">std::shared_ptr&lt;MyClass&gt; <span class="hljs-title">getSharedPtr</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">shared_from_this</span>(); <span class="hljs-comment">// ä½¿ç”¨ enable_shared_from_this çš„æ­£ç¡®æ–¹å¼</span><br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;MyClass instance&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// æ­£ç¡®æ–¹å¼ï¼šä½¿ç”¨ std::make_shared åˆ›å»º shared_ptr</span><br>    std::shared_ptr&lt;MyClass&gt; obj1 = std::<span class="hljs-built_in">make_shared</span>&lt;MyClass&gt;();<br>    <span class="hljs-comment">// ä½¿ç”¨æˆå‘˜å‡½æ•°åˆ›å»ºå¦ä¸€ä¸ªå…±äº«çš„ shared_ptr</span><br>    std::shared_ptr&lt;MyClass&gt; obj2 = obj1-&gt;<span class="hljs-built_in">getSharedPtr</span>();<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052013086.png" alt="image.png"></p><h3 id="shared-ptr-weak-pträ¼ªä»£ç å®ç°"><a href="#shared-ptr-weak-pträ¼ªä»£ç å®ç°" class="headerlink" title="shared_ptr weak_pträ¼ªä»£ç å®ç°"></a><strong>shared_ptr weak_pträ¼ªä»£ç å®ç°</strong></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">control_block</span><br>&#123;<br>    T* object;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">Dispose</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">Delete</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;<br>    std::atomic&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt; shareds;<br>    std::atomic&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt; weaks;<br>&#125;;<br><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">shared_ptr</span><br>&#123;<br>    control_block&lt;T&gt;* control;<br>&#125;;<br><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">weak_ptr</span><br>&#123;<br>    control_block&lt;T&gt;* control;<br>&#125;;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202411052013439.png" alt="image.png"></p><ul><li><code>strong ref</code> å’Œ <code>weak ref</code>æ˜¯åˆ†åˆ«è®°å½•äº†æ­¤æ—¶æŒ‡å‘è¯¥objectçš„<code>shared_ptr</code>å’Œ <code>weak_ptr</code>çš„ä¸ªæ•°ã€‚</li><li><code>_Uses</code> å’Œ <code>_Weaks</code> æ˜¯æ–¹ä¾¿é‡Šæ”¾èµ„æºçš„è®¡æ•°ã€‚<code>_Uses</code> &#x3D; å¼ºå¼•ç”¨è®¡æ•° <code>_Weaks</code> &#x3D; å¼±å¼•ç”¨è®¡æ•° + <strong>bool(æ˜¯å¦å­˜åœ¨shared_ptr)</strong></li><li>ä¹Ÿå°±æ˜¯åªè¦æœ‰ â‰¥ 1ä¸ª<code>shared_ptr</code> åˆ™<code>_Weaks</code>å°±è¦+1</li><li>è¿™æ ·åšæ˜¯ä¸ºäº†æ–¹ä¾¿åªéœ€è¦å¯¹<code>_Weaks</code>åšä¸€æ¬¡åŸå­æ£€æŸ¥å°±ç¡®å®šæ˜¯å¦é‡Šæ”¾èµ„æºï¼Œè€Œä¸éœ€è¦åˆ†åˆ«æ£€æŸ¥<code>shared_ptr</code>ä¸ªæ•°å’Œ<code>weak_ptr</code>ä¸ªæ•°</li></ul><p>Ref: <a href="https://devblogs.microsoft.com/oldnewthing/20230814-00/?p=108597">STL å†…éƒ¨ï¼šæ™ºèƒ½æŒ‡é’ˆ - è€æ–°äº‹ç‰© â€” Inside STL: Smart pointers - The Old New Thing</a></p><p><a href="https://stackoverflow.com/questions/49585818/why-does-shared-ptr-needs-to-hold-reference-counting-for-weak-ptr">c++ - ä¸ºä»€ä¹ˆshared_ptréœ€è¦ä¿å­˜weak_ptrçš„å¼•ç”¨è®¡æ•°ï¼Ÿ - å †æ ˆæº¢å‡º â€” c++ - Why does shared_ptr needs to hold reference counting for weak_ptr? - Stack Overflow</a></p><h2 id="Bonus-Viewing"><a href="#Bonus-Viewing" class="headerlink" title="Bonus Viewing:"></a>Bonus Viewing:</h2><p><a href="https://www.reddit.com/r/cpp/comments/5do55l/heres_everything_i_know_about_shared_ptr/">è¿™æ˜¯æˆ‘æ‰€çŸ¥é“çš„æœ‰å…³ shared_ptr çš„æ‰€æœ‰å†…å®¹ï¼šr&#x2F;cpp â€” Hereâ€™s everything I know about shared_ptr : r&#x2F;cpp</a></p><p> <a href="https://stackoverflow.com/questions/20895648/difference-in-make-shared-and-normal-shared-ptr-in-c">c++11 - C++ä¸­make_sharedå’Œæ™®é€šshared_ptrçš„åŒºåˆ« - VoidCC â€” c++11 - Difference in make_shared and normal shared_ptr in C++ - Stack Overflow</a></p><p><a href="https://www.reddit.com/r/cpp/comments/pbiyre/comment/hac69lb/">ä»…ä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥æ–­è¨€å¼•ç”¨çš„å¯¿å‘½ä¸ä¼šæ¯”å¯¹è±¡é•¿ï¼Ÿ ï¼šr&#x2F;cpp â€” Using reference counting only to assert that references do not outlive an object? : r&#x2F;cpp</a></p><p><a href="https://stackoverflow.com/questions/712279/what-is-the-usefulness-of-enable-shared-from-this">c++ - What is the usefulness of <code>enable_shared_from_this</code>? - Stack Overflow</a></p><p><a href="https://stackoverflow.com/questions/43297517/stdshared-ptr-internals-weak-count-more-than-expected">c++ - std::shared_ptr å†…éƒ¨ç»“æ„ï¼Œå¼±è®¡æ•°è¶…å‡ºé¢„æœŸ - ä»£ç æ—¥å¿— â€” c++ - std::shared_ptr internals, weak count more than expected - Stack Overflow</a></p><p><a href="https://stackoverflow.com/questions/5913396/why-do-stdshared-ptrvoid-work?rq=2">c++ - Why do std::shared_ptr<void> work - Stack Overflow</a>ï¼ˆç¥å¥‡trick ç±»å‹æ“¦é™¤ï¼‰</p><p><a href="https://www.reddit.com/r/cpp/comments/3eia29/comment/ctfeh1p/">std::shared_ptr çš„ç§˜å¯†æ„é€ å‡½æ•°ï¼šr&#x2F;cpp â€” std::shared_ptrâ€™s secret constructor : r&#x2F;cpp</a>ï¼ˆæ­¤å‘è¨€æ²¡æœ‰æŒ‡æ˜ä»»ä½•é”æ“ä½œï¼Œè¯•å›¾è¯´æ˜weak countå¦‚æœä¸åŒ…å«shared_ptrçš„è®¡æ•°ï¼ˆå³åªè¦å­˜åœ¨sharedptrï¼Œweaks+1ï¼‰å°±ä¼šå‡ºé”™ï¼Œä½†æ˜¯ç»“åˆChençš„blogï¼Œé¡¶å¤šå¢åŠ äº†åŸå­æ£€æŸ¥çš„æ“ä½œæ€§èƒ½æŸè€—ã€‚</p><p><a href="https://learn.microsoft.com/en-us/archive/msdn-magazine/2004/december/c-q-a-deleting-managed-objects-wrapping-a-library-and-more">C++ é—®ç­”ï¼šåˆ é™¤æ‰˜ç®¡å¯¹è±¡ã€åŒ…è£…åº“ç­‰ |å¾®è½¯å­¦ä¹  â€” C++ Q&amp;A: Deleting Managed Objects, Wrapping a Library, and More | Microsoft Learn</a> ï¼ˆå¤ªå¥½äº†æ˜¯å¾®è½¯å¼€å‘æ‚è°ˆï¼‰</p>]]></content>
    
    
    <categories>
      
      <category>C++parallel101</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C++</tag>
      
      <tag>RAII</tag>
      
      <tag>æ™ºèƒ½æŒ‡é’ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç½‘ç»œå¹¼å„¿ç§‘æ™®è¯»ç‰©01â€”â€”â€”â€”internet/https</title>
    <link href="/2024/09/08/internet-https/"/>
    <url>/2024/09/08/internet-https/</url>
    
    <content type="html"><![CDATA[<h1 id="ç½‘ç»œå¹¼å„¿ç§‘æ™®è¯»ç‰©01"><a href="#ç½‘ç»œå¹¼å„¿ç§‘æ™®è¯»ç‰©01" class="headerlink" title="ç½‘ç»œå¹¼å„¿ç§‘æ™®è¯»ç‰©01"></a>ç½‘ç»œå¹¼å„¿ç§‘æ™®è¯»ç‰©01</h1><blockquote><p>å®¡ç¨¿äºº: MrBeanC é˜¿é‡Œå¤šå¤š^^</p></blockquote><h2 id="curl-vs-ping"><a href="#curl-vs-ping" class="headerlink" title="curl vs ping"></a>curl vs ping</h2><ul><li><strong>curl</strong>ï¼šç”¨äºå‘é€ HTTP&#x2F;HTTPS ç­‰åº”ç”¨å±‚åè®®çš„è¯·æ±‚ï¼Œå¹¶è·å–æœåŠ¡å™¨å“åº”ï¼Œä¸»è¦ç”¨äºç½‘ç»œåº”ç”¨å±‚çš„æ•°æ®äº¤äº’ã€‚</li><li><strong>ping</strong>ï¼šç”¨äºç½‘ç»œå±‚çš„è¿æ¥æµ‹è¯•ï¼Œé€šè¿‡ ICMP åè®®ç¡®è®¤ç›®æ ‡è®¾å¤‡æ˜¯å¦å¯è¾¾ï¼Œå¸¸ç”¨äºè¯Šæ–­ç½‘ç»œè¿é€šæ€§é—®é¢˜ã€‚</li></ul><p><a href="https://superuser.com/questions/920491/why-does-curl-command-work-normally-while-ping-not">ç¥å¥‡é—®é¢˜ï¼šcurlé€špingä¸é€šï¼ˆè®¡ç®—æœºç½‘ç»œçœŸæ˜¯å¤ªå¥‡å¦™leï¼‰</a></p><h2 id="ä¸ºä»€ä¹ˆéœ€è¦åŸŸåè®¿é—®ï¼Ÿä¸ç›´æ¥ç”¨IPå‘¢"><a href="#ä¸ºä»€ä¹ˆéœ€è¦åŸŸåè®¿é—®ï¼Ÿä¸ç›´æ¥ç”¨IPå‘¢" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦åŸŸåè®¿é—®ï¼Ÿä¸ç›´æ¥ç”¨IPå‘¢"></a>ä¸ºä»€ä¹ˆéœ€è¦åŸŸåè®¿é—®ï¼Ÿä¸ç›´æ¥ç”¨IPå‘¢</h2><ul><li>è¾“å…¥åŸŸåæµè§ˆå™¨ä¼šè‡ªåŠ¨è¡¥å……ä¸ºhttpsåè®®è®¿é—®ï¼ŒåŸŸåä¼šè¢«è§£æä¸ºipåœ°å€</li><li>åŸŸåæ˜¯ä¸ºäº†human-readable :) æœåŠ¡å™¨çœŸå®åœ°å€å¯èƒ½å˜åŒ–ï¼Œä¾‹å¦‚æœåŠ¡å™¨åˆ°æœŸï¼Œorå†…ç½‘é‡‡ç”¨DDNSï¼Œä½†æ˜¯ç”¨æˆ·åªéœ€è¦è®°ä½å›ºå®šçš„åŸŸå</li></ul><blockquote><p>å®‰å…¨è¯ä¹¦ä¹Ÿå¯ä»¥ç»™å…¬å…±IPï¼Œä¿è¯IPçš„è®¿é—®å®‰å…¨æ€§~</p></blockquote><h3 id="ç§æœ‰-IP-åœ°å€èŒƒå›´"><a href="#ç§æœ‰-IP-åœ°å€èŒƒå›´" class="headerlink" title="ç§æœ‰ IP åœ°å€èŒƒå›´"></a>ç§æœ‰ IP åœ°å€èŒƒå›´</h3><p>æ ¹æ® RFC 1918ï¼Œä»¥ä¸‹ä¸‰ä¸ª IP åœ°å€èŒƒå›´è¢«ä¿ç•™ä¸ºç§æœ‰åœ°å€ï¼š</p><p>ç§æœ‰åœ°å€ &#x3D;&#x3D; ä¸èƒ½åœ¨äº’è”ç½‘ä¸­è¢«è·¯ç”±</p><ol><li><strong>10.0.0.0 - 10.255.255.255</strong> ï¼ˆ<code>10.x.x.x</code>ï¼‰:<ul><li>æ”¯æŒçš„åœ°å€æ•°é‡ï¼š16,777,216 ä¸ª</li><li>é€šå¸¸ç”¨äºå¤§å‹ä¼ä¸šç½‘ç»œ</li></ul></li><li><strong>172.16.0.0 - 172.31.255.255</strong> ï¼ˆ<code>172.16.x.x</code> è‡³ <code>172.31.x.x</code>ï¼‰:<ul><li>æ”¯æŒçš„åœ°å€æ•°é‡ï¼š1,048,576 ä¸ª</li><li>é€šå¸¸ç”¨äºä¸­å‹ä¼ä¸šç½‘ç»œ</li></ul></li><li><strong>192.168.0.0 - 192.168.255.255</strong> ï¼ˆ<code>192.168.x.x</code>ï¼‰:<ul><li>æ”¯æŒçš„åœ°å€æ•°é‡ï¼š65,536 ä¸ª</li><li>é€šå¸¸ç”¨äºå®¶åº­ç½‘ç»œå’Œå°å‹ä¼ä¸šç½‘ç»œ</li></ul></li></ol><h3 id="HTTPè¯·æ±‚æ˜¯ä»å“ªä¸ªç«¯å£å‘å‡ºçš„"><a href="#HTTPè¯·æ±‚æ˜¯ä»å“ªä¸ªç«¯å£å‘å‡ºçš„" class="headerlink" title="HTTPè¯·æ±‚æ˜¯ä»å“ªä¸ªç«¯å£å‘å‡ºçš„"></a>HTTPè¯·æ±‚æ˜¯ä»å“ªä¸ªç«¯å£å‘å‡ºçš„</h3><ul><li><strong>å®¢æˆ·ç«¯</strong>å‘èµ· HTTP è¯·æ±‚æ—¶ï¼Œä¼šä»ä¸€ä¸ªéšæœºé«˜ä½ç«¯å£ï¼ˆ49152-65535ï¼‰å‘å‡ºã€‚</li><li><strong>æœåŠ¡å™¨</strong>æ¥æ”¶ HTTP è¯·æ±‚çš„é»˜è®¤ç«¯å£æ˜¯ 80ï¼ˆé™¤éä½¿ç”¨äº†å…¶ä»–è‡ªå®šä¹‰ç«¯å£ï¼‰ã€‚HTTPSæ˜¯443ç«¯å£ã€‚</li></ul><p><a href="https://www.golinuxcloud.com/set-up-proxy-http-proxy-environment-variable/">åœ¨ Linux ä¸­ä½¿ç”¨ http_proxy å’Œ https_proxy ç¯å¢ƒå˜é‡è®¾ç½®ä»£ç†ï¼Ÿ</a></p><p>ç¯å¢ƒå˜é‡http_proxy https_proxyæ˜¯ä¼šæŠŠå¯¹åº”çš„è¯·æ±‚éƒ½å‘åˆ°å€¼çš„ipç«¯å£ä¸Šï¼Œç”±ç›‘å¬è¯¥ç«¯å£çš„æœåŠ¡å†è¿›è¡Œè½¬å‘</p><p><a href="https://about.gitlab.com/blog/2021/01/27/we-need-to-talk-no-proxy/">NO_PROXY</a></p><p><a href="https://superuser.com/questions/944958/are-http-proxy-https-proxy-and-no-proxy-environment-variables-standard">HTTP_PROXYã€HTTPS_PROXY å’Œ NO_PROXY ç¯å¢ƒå˜é‡æ˜¯å¦æ ‡å‡†</a> </p><h3 id="ip-ç«¯å£-â‡’-socketå¥—æ¥å­—"><a href="#ip-ç«¯å£-â‡’-socketå¥—æ¥å­—" class="headerlink" title="ip+ç«¯å£ â‡’ socketå¥—æ¥å­—"></a>ip+ç«¯å£ â‡’ socketå¥—æ¥å­—</h3><p>æœ‰äº†ä¸åŒçš„ç«¯å£åˆ†é…ç»™ä¸åŒçš„è¿›ç¨‹ï¼Œç”µè„‘å¯ä»¥è¿›è¡Œå¤šä¸ªè¿›ç¨‹è¿è¡Œå’Œåˆ‡æ¢ã€‚ç«¯å£ä¼šä¸ä¼šè¢«å ç”¨ç©å®Œå‘¢ï¼Ÿå‡ ä¹ä¸å¯èƒ½å™¢ï¼Œå› ä¸ºpcä¼šç»´æŠ¤ç«¯å£ï¼Œè¿›ç¨‹ç»“æŸé‡Šæ”¾ç«¯å£ï¼Œå¹¶ä¸”ä¸€ä¸ªç«¯å£å¯ä»¥å¤„ç†ä¸€ä¸ªç¨‹åºçš„å¤šä¸ªè¯·æ±‚ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>internet</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸‘ä¸‘å¤´åƒâ€”â€”ä¸ªäººåšå®¢è¯„è®ºç³»ç»Ÿvalineéƒ¨ç½²å°è®°</title>
    <link href="/2024/07/21/valine-comments/"/>
    <url>/2024/07/21/valine-comments/</url>
    
    <content type="html"><![CDATA[<h2 id="éœ€æ±‚â€”â€”ä¸ªäººåšå®¢ç½‘ç«™è¯„è®ºåŒº"><a href="#éœ€æ±‚â€”â€”ä¸ªäººåšå®¢ç½‘ç«™è¯„è®ºåŒº" class="headerlink" title="éœ€æ±‚â€”â€”ä¸ªäººåšå®¢ç½‘ç«™è¯„è®ºåŒº"></a>éœ€æ±‚â€”â€”ä¸ªäººåšå®¢ç½‘ç«™è¯„è®ºåŒº</h2><p>æƒ³è¦è®©è‡ªå·±çš„åšå®¢ç½‘ç«™æ”¯æŒç•™è¨€ï¼Œè£…æ‰®hexoç©ºé—´:)</p><h2 id="å¯¹æ¯”æŠ€æœ¯â€”â€”Gitalk-or-Valine-LeanCloud"><a href="#å¯¹æ¯”æŠ€æœ¯â€”â€”Gitalk-or-Valine-LeanCloud" class="headerlink" title="å¯¹æ¯”æŠ€æœ¯â€”â€”Gitalk or Valine+LeanCloud"></a>å¯¹æ¯”æŠ€æœ¯â€”â€”<strong>Gitalk</strong> or Valine+LeanCloud</h2><blockquote><p>Gitalk æ˜¯ä¸€ä¸ªåŸºäº Github issues çš„è¯„è®ºç³»ç»Ÿã€‚</p></blockquote><p><strong>Gitalk steps:</strong></p><ul><li>æ³¨å†Œä¸€ä¸ªæ–°çš„Â <strong>GitHub Application</strong>Â æ¥æˆæƒ</li><li>ä¿®æ”¹configé…ç½®å¯ç”¨Gitalk</li></ul><p>é€šè¿‡Gitalkçš„readmeï¼Œè‡ªåŠ¨è·³è½¬åˆ°äº†OAuth applicationçš„æ³¨å†Œç•Œé¢ï¼ŒOAuth applicationä¸ç­‰åŒäºGithub applicationã€‚è™½ç„¶ä¸¤è€…éƒ½æ˜¯ä¸ºäº†èƒ½å¤Ÿæš´éœ²GitHubçš„ä»“åº“æ“ä½œAPIï¼ŒOAuth applicationå¹¶ä¸èƒ½é™åˆ¶ä½¿ç”¨GitHubçš„æƒé™é™åº¦ã€‚OAuth applicationå¯ä»¥ç±»æ¯”qqæˆæƒç»™å¦ä¸€ä¸ªç½‘ç«™ç™»å½•ä½¿ç”¨qqçš„ä¸ªäººä¿¡æ¯ï¼ŒOAuth applicationçš„å›è°ƒï¼ˆcallbackï¼‰urlå°±æ˜¯ä¸ªäººåšå®¢ç½‘ç«™urlï¼Œå³æ¥æ”¶GitHubå‘é€çš„tokençš„ä¸€æ–¹ã€‚ç”±äºhexoçš„æ˜æ–‡ä¼ è¾“ï¼Œè¿™ä¸ªtokenç†è®ºä¸Šæ˜¯ä¼šè¢«æš´éœ²åœ¨å‰ç«¯çš„æŸä¸ªjsæ–‡ä»¶ä¸­</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202407212341648.png" alt="screenshot"></p><p><strong>æš´éœ²æ˜¯å¦æ˜¯å®‰å…¨å‘¢ï¼Ÿç­”æ¡ˆï¼šso far so good</strong></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202407212341908.png" alt="Untitled"></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202407212341874.png" alt="Untitled"></p><ul><li>å…³é”®åœ¨äºcallback urlä¸å¯æ”¹ï¼ŒæŒ‡å‘çš„æˆ‘ä»¬è‡ªå·±çš„åšå®¢æ˜¯å—ä¿¡ä»»çš„ï¼Œå®‰å…¨çš„ã€‚ä½†æ˜¯å½“æˆ‘ä»¬ç‚¹åˆ«äººçš„åšå®¢æç¤ºéœ€è¦æˆæƒçš„æ—¶å€™ï¼Œå°±è¦å°å¿ƒäº†</li></ul><p><a href="https://github.com/gitalk/gitalk/issues/444">https://github.com/gitalk/gitalk/issues/444</a></p><p><strong>tokenæƒé™äº‰è®®</strong></p><ul><li>å¼•ç”¨çš„åšä¸»è®¤ä¸ºï¼šOAuth applicationä½¿ç”¨çš„tokenåº”è¯¥æ˜¯ä»…æœ‰åªè¯»æƒé™ ä½†æ˜¯è¿™ä½åšä¸»è‡ªå·±çš„è¯„è®ºåŒºè¿›è¡ŒGitHubæˆæƒæ—¶ï¼Œä¾ç„¶æç¤ºéœ€è¦æˆæƒread and writeã€‚å¼•ç”¨ï¼š<a href="https://carl-zk.github.io/blog/2020/03/03/gitalk-%E8%BF%90%E4%BD%9C%E5%8E%9F%E7%90%86/">Gitalk è¿ä½œåŸç† | ä¸€å¶è½»èˆŸæ¸¡ä¸‡æ±Ÿ (carl-zk.github.io)</a></li></ul><p>OAuthÂ AppÂ 5å¹´å‰åˆ›å»ºï¼Œ2019å¹´ï¼Œæ­¤æ—¶PRè¿˜æ²¡æï¼Œè¿˜æ˜¯readÂ write</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202407212341044.png" alt="Untitled"></p><p>2020.2Â PRåˆå¹¶ï¼Œtokençš„æƒé™ä»è¯»å†™æƒæ”¹ä¸ºreadÂ only </p><p><a href="https://github.com/gitalk/gitalk/pull/344">https://github.com/gitalk/gitalk/pull/344</a></p><p>2020.3åšä¸»è°ƒæŸ¥ä¹‹åÂ å†™ä¸‹readÂ onlyçš„ç»“è®º</p><p><strong>Valine+LeanCloud steps:</strong> </p><ul><li>æ³¨å†ŒLeanCloud<a href="https://console.leancloud.cn/apps">LeanCloud</a></li><li>å‚è€ƒstunä¸»é¢˜çš„valineéƒ¨ç½²æ–¹å¼<a href="https://theme-stun.github.io/docs/zh-CN/advanced/third-part.html#valine">ç¬¬ä¸‰æ–¹æ”¯æŒ | hexo-theme-stun</a></li></ul><p>å¯¹æ¯”Gitalkå’ŒValineï¼ŒGitalkæœ‰ä¸€å®šçš„é£é™©w è€ŒValineè™½ç„¶ä¸ä¸€å®šç¨³å®šï¼Œä½†æ˜¯åˆ åº“è·‘è·¯çš„é£é™©æ˜¯0.0000001ã€‚æ‰€ä»¥é€‰æ‹©Valineï¼œï¼ˆï¼¾ï¼ï¼¾ï¼‰ï¼</p><h2 id="å¤´åƒæ˜¯ä¸‘ä¸‘äººå„¿æ€ä¹ˆåŠå‘¢"><a href="#å¤´åƒæ˜¯ä¸‘ä¸‘äººå„¿æ€ä¹ˆåŠå‘¢" class="headerlink" title="å¤´åƒæ˜¯ä¸‘ä¸‘äººå„¿æ€ä¹ˆåŠå‘¢"></a>å¤´åƒæ˜¯ä¸‘ä¸‘äººå„¿æ€ä¹ˆåŠå‘¢</h2><p>å½“å®Œæˆäº†è¯„è®ºåŒºçš„åŸºæœ¬éƒ¨ç½²ï¼Œéœ€è¦é€‰æ‹©é»˜è®¤å¤´åƒæ ·å¼ã€‚è¿™é‡Œå¯ä»¥é€‰æ‹©ç¥ç§˜äººæ ·å¼ï¼Œæˆ–è€…wavatarå°æ€ªç‰©ã€‚ä½†æ˜¯æ²¡æœ‰äººæƒ³åˆ°å½“VPN+æ— é‚®ç®±æµ‹è¯•ç•™è¨€è¯„è®ºï¼Œå¤´åƒæ˜¯ä¸‘ä¸‘äººå„¿ï¼ï¼ˆåœ¨é…ç½®ä¸­å‘½åé…ç½®çš„æ˜¯wavatarï¼ï¼‰</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202407212340677.png" alt="Untitled"></p><p>å°å‘ï¼šéœ€è¦æ³¨æ„notifyï¼šverifyï¼šç±»ä¼¼è¿™ç§çš„é…ç½®æ–‡ä»¶æœ‰åˆ—å‡ºçš„é¡¹ç›®ï¼Œä¸èƒ½ç›´æ¥æ³¨é‡Šæ‰ï¼ˆè¿™æ˜¯å¿…é¡»é¡¹ï¼‰åº”è¯¥å†™falseæ¥ç¦ç”¨</p><p>ç»è¿‡å’Œclsçš„ä¸€ä¸ªä¸‹åˆæµ‹è¯•ï¼Œç»“è®ºå¦‚ä¸‹ï¼š</p><ol><li>ä¸‘ä¸‘äººæ˜¯not found&#x2F;ç½‘ç»œæƒ…å†µä¸ä½³ç­‰å¼‚å¸¸çš„fallbackï¼ˆ302ï¼‰</li><li>ä¸å¼€æ¢¯å­åè€Œå¯ä»¥çœ‹åˆ°æ­£å¸¸äººï¼ˆmpï¼‰ä¹Ÿå¯ä»¥æœ‰wavatar</li><li>wavataréœ€è¦å¡«å†™qqé‚®ç®± æ¯ä¸ªé‚®ç®±éšæœºå¯¹åº”ä¸€ä¸ªwavatar</li><li>ä¸å¡«å†™é‚®ç®±åªèƒ½æ˜¾ç¤ºmpï¼ˆorä¸‘ä¸‘äººï¼‰</li><li><code>enableQQ</code>åœ¨é…ç½®ä¸­æ˜¯æ— æ•ˆçš„</li><li>åœ¨å¼€VPNæƒ…å†µä¸‹ï¼Œå¡«å†™é‚®ç®±ï¼Œå¯ä»¥æ­£ç¡®åŠ è½½å¤´åƒï¼Œè¿™å¹¶ä¸æ˜¯ç½‘ç»œåŸå› ï¼Œåªæ˜¯ç±³æœ‰äº†é‚®ç®±ç”¨äºæ ‡è¯†é€ æˆçš„not found (bug maybe)</li></ol><p>ä¸€è¨€è”½ä¹‹ï¼šåªæœ‰åœ¨<code>VPN + æ— é‚®ç®±</code>çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šæ˜¾ç¤ºä¸‘äºº (302)</p><p>ä¸€æ—¦ç”Ÿæˆå¤´åƒï¼Œä¼šæ°¸ä¹…å’Œé‚®ç®±ç»‘å®š</p><p>ç–‘æƒ‘ï¼šä¸ºä»€ä¹ˆæœ‰VPNåè€Œnot found (302)</p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202407212341687.png" alt="Untitled"></p><p><img src="https://raw.githubusercontent.com/pinkyrie/pic/main/202407212341955.png" alt="Untitled"></p><p>aa æ²¡æœ‰mailéƒ½æ˜¯ä¸‘ä¸‘äººå„¿ï¼</p><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref:"></a>Ref:</h2><p><a href="https://valine.js.org/avatar.html">å¤´åƒé…ç½® | Valine ä¸€æ¬¾å¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„æ— åç«¯è¯„è®ºç³»ç»Ÿã€‚</a>(æˆ‘ä»¬ä¼šå‘ç°è¿™ä¸ªé‡Œé¢è¯„è®ºåŒºå¤´åƒå›¾ç‰‡è·å–çš„é“¾æ¥å’Œæˆ‘ä»¬ä½¿ç”¨çš„å¤´åƒè·å–urlä¸å¤ªä¸€æ ·å‘¢ï¼‰</p><p><a href="https://theme-stun.github.io/docs/zh-CN/advanced/third-part.html#valine">ç¬¬ä¸‰æ–¹æ”¯æŒ | hexo-theme-stun</a></p><p><a href="https://github.com/gitalk/gitalk/issues?page=1&q=secret">https://github.com/gitalk/gitalk/issues?page=1&q=secret</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>valine blog-comments</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
